// This file outlines the process by which the raw data files generated by z-Tree are converted for statistical analysis. 

// z-Tree generates two files in each experimental session: a file with decision data file (format 'yymmdd_hhmm.xls') and a questionnaire data file (format 'yymmdd_hhmm.sbj'). The .xls file generated by Stata has compatibility issues with most software packages for reasons I don't understand, so files must be converted to .csv format. The original .sbj files contained indentifying information used for payment, and I deleted that information prior to the files being uploaded, as per ethics requirements, and added a variable (sessiondate_time) which enables the data to be merged with decision data. In the process, I converted the .sbj files into .csv format, and are now formatted as ('yymmdd_hhmm_q.csv'), where the suffix '_q' indicates questionnaire.

// The z-Tree code generates additional variables for the TS treatment. Therefore, I will generate code for each type of file. There is definitely a more effective way to do this, but there we are. 

** Cleaning TS Treatment decision data files.

** import decision data .csv file

import delimited "/Users/maf206/Desktop/yymmdd_hhmm.csv", varnames(nonames) case(preserve) encoding(UTF-8)

drop if v2 != 2
drop if v3 != "subjects"
drop in 1

// These variables are ancillary variables generated by the z-Tree code, or redundant variables. 
drop v2 v3 v8 v9 v18 v19 v20 v21 v28 v29 v30 v31 v32 v33 v39 v40 v41 v42 v43 v44 v50 v51 v52 v53 v54 v55 v56 v57 v58 v59 v60

rename v1 sessiondate_time // variable denoting date and time of session. Format: yymmdd_hhmm.
rename v4 period // maybe drop
rename v5 subject // subject ID in session
rename v6 group // group ID in session
rename v7 profit // payoff in ECU
rename v10 treatment // need to check that this is different in other treatment; otherwise, treatment dummy = x if OS; z if TS.
rename v11 cost // cost parameter
rename v12 prize1 // loser prize
rename v13 prize2 // winner prize in OS
rename v14 prize3 // winner prize in stage 2 TS
rename v15 support // support of the random number generator (experimental default is 60 i.e. [-60, 60])
rename v16 effort_t1 // individual effort choice in stage 1
rename v17 effort_t2 // individual effort choice in stage 2
rename v22 random_t1 // random number (rounded) in stage 1
rename v23 random_t2 // random number (rounded) in stage 2
rename v24 output_t1 // effort_t1 + output_t1
rename v25 output_t2 // effort_t2 + output_t2
rename v26 cost_t1 // cost of effort in t1
rename v27 cost_t2 // cost of effort in t2
rename v34 expectation1_t1 // belief about effort by player t+1 (where players are ordered clockwise in a circle, where t is the decision-maker and +x indicates xth player to their right.)
rename v35 expectation2_t1 // belief about effort by player t+2 (where players are ordered clockwise in a circle, where t is the decision-maker and +x player xth position to their right.)
rename v36 expectation3_t1 // belief about effort by player t+3 (where players are ordered clockwise in a circle, where t is the decision-maker and +x indicates xth player to their right.)
rename v37 expectation1_t2 // belief about effort by player t+1 in stage 2 (where players are ordered clockwise in a circle, where t is the decision-maker and +x indicates xth player to their right.) For stage 1 losers, these beliefs apply to winners; for winners, this belief applies to the other player.
rename v38 expectation2_t2 // belief about effort by player t+2 (where players are ordered clockwise in a circle, where t is the decision-maker and +x player xth position to their right.) Should be 0 for stage 1 winners and will be replaced with a missing observation later in the code.
rename v45 rank // final ranking at the end of the contest
rename v46 finalist // =1 if proceeded to stage 2, 0 otherwise
rename v47 winner // =1 if winner, =0 if loser.
rename v48 time_spent_effort_t1 // time spent (in seconds) on effort decision in t1
rename v49 time_spent_belief_t1 // time spent (in seconds) on belief decision in t2


destring period subject group profit treatment cost prize1 prize2 prize3 support effort_t1 effort_t2 random_t1 random_t2 output_t1 output_t2 cost_t1 cost_t2 expectation1_t1 expectation2_t1 expectation3_t1 expectation1_t2 expectation2_t2 rank finalist winner time_spent_effort_t1 time_spent_belief_t1, replace

** File should then be saved as .dta in order to merge

** Cleaning OS Treatment decision data files.

** import decision data .csv file

import delimited "/Users/maf206/Desktop/yymmdd_hhmm.csv", varnames(nonames) case(preserve) encoding(UTF-8)

drop if v2 != 2
drop if v3 != "subjects"
drop in 1

// These variables are ancillary variables generated by the z-Tree code, or redundant variables. 

drop v2 v3 v8 v9 v18 v17 v19 v20 v27 v28 v29 v30 v31 v32 v38 v39 v40 v41 v42 v48 v49 v50 v51

rename v1 sessiondate_time // variable denoting date and time of session. Format: yymmdd_hhmm.
rename v4 period // maybe drop
rename v5 subject // subject ID in session
rename v6 group // group ID in session
rename v7 profit // payoff in ECU
rename v10 treatment // = 1 if OS; = 2 if TS.
rename v11 cost // cost parameter
rename v12 prize1 // loser prize
rename v13 prize2 // winner prize in OS
rename v14 support // support of the random number generator (experimental default is 60 i.e. [-60, 60])
rename v15 effort_t1 // individual effort choice in stage 1
rename v16 effort_t2 // individual effort choice in stage 2 (always 0 since there is no stage 2)
rename v21 random_t1 // random number (rounded) in stage 1
rename v22 random_t2 // random number (rounded) in stage 2
rename v23 output_t1 // effort_t1 + output_t1
rename v24 output_t2 // effort_t2 + output_t2
rename v25 cost_t1 // cost of effort in t1
rename v26 cost_t2 // cost of effort in t2
rename v33 expectation1_t1 // belief about effort by player t+1 (where players are ordered clockwise in a circle, where t is the decision-maker and +x indicates xth player to their right.)
rename v34 expectation2_t1 // belief about effort by player t+2 (where players are ordered clockwise in a circle, where t is the decision-maker and +x player xth position to their right.)
rename v35 expectation3_t1 // belief about effort by player t+3 (where players are ordered clockwise in a circle, where t is the decision-maker and +x indicates xth player to their right.)
rename v36 expectation1_t2 // always 0 as there is no stage 2
rename v37 expectation2_t2 // always 0 as there is no stage 2
rename v43 rank // final ranking at the end of the contest
rename v44 finalist // =1 if top 2 in group, 0 otherwise
rename v45 winner // =0 since there are two winners.
rename v46 time_spent_effort_t1 // time spent (in seconds) on effort decision in t1
rename v47 time_spent_belief_t1 // time spent (in seconds) on belief decision in t2

destring period subject group profit treatment cost prize1 prize2 support effort_t1 effort_t2 random_t1 random_t2 output_t1 output_t2 cost_t1 cost_t2 expectation1_t1 expectation2_t1 expectation3_t1 expectation1_t2 expectation2_t2 rank finalist winner time_spent_effort_t1 time_spent_belief_t1, replace

** File should then be saved as .dta in order to merge

** Cleaning questionnaire files
import delimited "/Users/maf206/Desktop/211013_0934_q.csv", varnames(nonames) case(preserve) encoding(UTF-8) clear 
import delimited yymmdd_hhmm_q.csv, varnames(nonames) case(preserve) encoding(UTF-8) clear 

drop in 1
** ssc install sxpose (the sxpose package transposes datasets)
sxpose, clear

drop _var2
rename _var1 subject
rename _var3 gender
rename _var4 major
rename _var5 year
rename _var6 age
rename _var7 open_ended_quiz
rename _var8 sessiondate_time
drop in 1

** only destringing variables that are required for merging data files 
destring subject age, replace

** File should then be saved as .dta in order to merge


** Testing H* (on merged dataset)

ranksum effort_t1, by(treatment)

